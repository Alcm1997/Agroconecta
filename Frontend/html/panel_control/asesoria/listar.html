<!-- ✅ SECCIÓN: ASESORÍAS -->
<div class="dashboard-card">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1"><i class="fas fa-comments text-primary me-2"></i>Consultas de Asesoría</h4>
            <p class="text-muted mb-0">Gestiona las consultas de asesoría gratuita</p>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="filtroEstado" style="width: auto;">
                <option value="">Todos</option>
                <option value="Pendiente">Pendientes</option>
                <option value="Respondida">Respondidas</option>
                <option value="Cerrada">Cerradas</option>
            </select>
            <button class="btn btn-outline-primary btn-sm" onclick="cargarAsesorias()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Stats rápidas -->
    <div class="row mb-4" id="statsAsesorias">
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="border rounded p-3 text-center bg-warning bg-opacity-10">
                <h3 class="mb-0 text-warning" id="statPendientes">0</h3>
                <small class="text-muted">Pendientes</small>
            </div>
        </div>
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="border rounded p-3 text-center bg-success bg-opacity-10">
                <h3 class="mb-0 text-success" id="statRespondidas">0</h3>
                <small class="text-muted">Respondidas</small>
            </div>
        </div>
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="border rounded p-3 text-center bg-secondary bg-opacity-10">
                <h3 class="mb-0 text-secondary" id="statCerradas">0</h3>
                <small class="text-muted">Cerradas</small>
            </div>
        </div>
    </div>

    <!-- Tabla de asesorías -->
    <div class="table-responsive">
        <table class="table table-hover" id="tablaAsesorias">
            <thead class="table-light">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Mensaje</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="listaAsesorias">
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="fas fa-spinner fa-spin me-2"></i>Cargando consultas...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Ver Detalle -->
<div class="modal fade" id="modalDetalleAsesoria" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-envelope-open me-2"></i>Detalle de Consulta</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalleAsesoriaContent">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a id="btnResponderEmail" href="#" class="btn btn-success">
                    <i class="fas fa-reply me-1"></i>Responder por Email
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // ========== GESTIÓN DE ASESORÍAS ==========

    let asesoriasData = [];

    function getToken() {
        return localStorage.getItem('panelToken') || localStorage.getItem('token');
    }

    async function cargarAsesorias() {
        const token = getToken();
        const tbody = document.getElementById('listaAsesorias');
        const filtroEstado = document.getElementById('filtroEstado').value;

        tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-4">
                <i class="fas fa-spinner fa-spin me-2"></i>Cargando...
            </td>
        </tr>
    `;

        try {
            let url = '/api/panel/asesorias';
            if (filtroEstado) url += `?estado=${filtroEstado}`;

            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Error al cargar asesorías');

            const data = await response.json();
            asesoriasData = data.consultas || [];

            // Actualizar stats
            actualizarStats(asesoriasData);

            if (asesoriasData.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No hay consultas registradas
                    </td>
                </tr>
            `;
                return;
            }

            tbody.innerHTML = asesoriasData.map(a => `
            <tr>
                <td><strong>#${a.id_consulta}</strong></td>
                <td>${escapeHtml(a.nombre)}</td>
                <td>
                    <a href="mailto:${a.email}" class="text-decoration-none">
                        ${escapeHtml(a.email)}
                    </a>
                </td>
                <td>
                    <span title="${escapeHtml(a.mensaje)}">
                        ${escapeHtml(a.mensaje.substring(0, 50))}${a.mensaje.length > 50 ? '...' : ''}
                    </span>
                </td>
                <td>${formatearFecha(a.fecha_consulta)}</td>
                <td>${getBadgeEstado(a.estado)}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="verDetalleAsesoria(${a.id_consulta})" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${a.estado === 'Pendiente' ? `
                            <button class="btn btn-outline-success" onclick="marcarRespondida(${a.id_consulta})" title="Marcar respondida">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        ${a.estado !== 'Cerrada' ? `
                            <button class="btn btn-outline-secondary" onclick="cerrarConsulta(${a.id_consulta})" title="Cerrar">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `).join('');

        } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error al cargar consultas
                </td>
            </tr>
        `;
        }
    }

    function actualizarStats(consultas) {
        const pendientes = consultas.filter(c => c.estado === 'Pendiente').length;
        const respondidas = consultas.filter(c => c.estado === 'Respondida').length;
        const cerradas = consultas.filter(c => c.estado === 'Cerrada').length;

        document.getElementById('statPendientes').textContent = pendientes;
        document.getElementById('statRespondidas').textContent = respondidas;
        document.getElementById('statCerradas').textContent = cerradas;
    }

    function getBadgeEstado(estado) {
        const badges = {
            'Pendiente': '<span class="badge bg-warning text-dark">Pendiente</span>',
            'Respondida': '<span class="badge bg-success">Respondida</span>',
            'Cerrada': '<span class="badge bg-secondary">Cerrada</span>'
        };
        return badges[estado] || `<span class="badge bg-info">${estado}</span>`;
    }

    function formatearFecha(fecha) {
        if (!fecha) return '-';
        return new Date(fecha).toLocaleDateString('es-PE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }

    async function verDetalleAsesoria(id) {
        const asesoria = asesoriasData.find(a => a.id_consulta === id);
        if (!asesoria) return;

        const content = document.getElementById('detalleAsesoriaContent');
        content.innerHTML = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label text-muted small">Nombre</label>
                <p class="mb-0 fw-bold">${escapeHtml(asesoria.nombre)}</p>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label text-muted small">Email</label>
                <p class="mb-0">
                    <a href="mailto:${asesoria.email}">${escapeHtml(asesoria.email)}</a>
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label text-muted small">Fecha de Consulta</label>
                <p class="mb-0">${formatearFecha(asesoria.fecha_consulta)}</p>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label text-muted small">Estado</label>
                <p class="mb-0">${getBadgeEstado(asesoria.estado)}</p>
            </div>
        </div>
        ${asesoria.fecha_respuesta ? `
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label text-muted small">Respondido por</label>
                <p class="mb-0">${escapeHtml(asesoria.respondido_por_nombre || '-')}</p>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label text-muted small">Fecha Respuesta</label>
                <p class="mb-0">${formatearFecha(asesoria.fecha_respuesta)}</p>
            </div>
        </div>
        ` : ''}
        <div class="mb-3">
            <label class="form-label text-muted small">Mensaje</label>
            <div class="p-3 bg-light rounded border" style="white-space: pre-wrap;">
                ${escapeHtml(asesoria.mensaje)}
            </div>
        </div>
    `;

        // Configurar botón de responder
        const subject = encodeURIComponent('Re: Asesoría Pitahaya Perú');
        const body = encodeURIComponent(`Hola ${asesoria.nombre},\n\nGracias por contactarnos. En respuesta a tu consulta:\n\n"${asesoria.mensaje.substring(0, 100)}..."\n\n[Tu respuesta aquí]\n\nSaludos,\nEquipo Pitahaya Perú`);
        document.getElementById('btnResponderEmail').href = `mailto:${asesoria.email}?subject=${subject}&body=${body}`;

        const modal = new bootstrap.Modal(document.getElementById('modalDetalleAsesoria'));
        modal.show();
    }

    async function marcarRespondida(id) {
        const result = await Swal.fire({
            title: '¿Marcar como respondida?',
            text: 'Esta acción indica que ya respondiste al cliente',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Sí, marcar',
            cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        try {
            const token = getToken();
            const response = await fetch(`/api/panel/asesorias/${id}/responder`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) throw new Error('Error al actualizar');

            Swal.fire('¡Actualizado!', 'La consulta fue marcada como respondida', 'success');
            cargarAsesorias();
        } catch (error) {
            Swal.fire('Error', 'No se pudo actualizar la consulta', 'error');
        }
    }

    async function cerrarConsulta(id) {
        const result = await Swal.fire({
            title: '¿Cerrar consulta?',
            text: 'La consulta se moverá a estado cerrado',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sí, cerrar',
            cancelButtonText: 'Cancelar'
        });

        if (!result.isConfirmed) return;

        try {
            const token = getToken();
            const response = await fetch(`/api/panel/asesorias/${id}/estado`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ estado: 'Cerrada' })
            });

            if (!response.ok) throw new Error('Error al cerrar');

            Swal.fire('¡Cerrada!', 'La consulta fue cerrada', 'success');
            cargarAsesorias();
        } catch (error) {
            Swal.fire('Error', 'No se pudo cerrar la consulta', 'error');
        }
    }

    // Event listener para filtro
    document.getElementById('filtroEstado').addEventListener('change', cargarAsesorias);

    // Cargar al iniciar
    cargarAsesorias();
</script>