<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Pitahaya Per√∫</title>
    <link rel="icon" type="image/png" href="/icono/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/icono/favicon.svg" />
    <link rel="shortcut icon" href="/icono/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icono/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="MyAgroiOS" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <style>
        body {
            position: relative;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('../../imagenes_pitahaya/fondo_login_2.png');
            background-size: cover;
            background-position: center;
            filter: blur(2px) brightness(0.9);
            z-index: -1;
        }
        
        .login-card {
            background: rgba(255,255,255,0.90);
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            padding: 2.5rem 2rem;
            width: 100%;
            max-width: 370px;
        }
        
        .login-title {
            color: #E91E63;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #E91E63;
            border-color: #E91E63;
        }
        
        .btn-primary:hover {
            background-color: #C2185B;
            border-color: #C2185B;
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            border-color: #ccc;
            cursor: not-allowed;
        }
        
        .form-label {
            color: #2E7D32;
            font-weight: 500;
        }
        
        .loading-spinner {
            display: none;
            margin-right: 10px;
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #dc3545;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 15px;
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 576px) {
            body {
                padding: 15px;
            }
            
            .login-card {
                padding: 2rem 1.5rem;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="login-card">
        <div class="text-center mb-3">
            <img src="../../imagenes_pitahaya/pitahaya.png" alt="Logo Pitahaya Per√∫" class="img-fluid" style="width:110px; height:110px; border-radius:50%; object-fit:cover; box-shadow:0 2px 12px rgba(0,0,0,0.10); border:4px solid #fff;">
        </div>
        
        <h2 class="login-title">
            <i class="fas fa-user-shield me-2"></i>Panel de Control
        </h2>
        
        <form id="loginPanelForm">
            <div class="mb-3">
                <label for="username" class="form-label">Usuario</label>
                <input 
                    type="text" 
                    class="form-control" 
                    id="username" 
                    name="username"
                    required 
                    placeholder="Ingresa tu usuario"
                    autocomplete="username"
                >
            </div>
            
            <div class="mb-3 position-relative">
                <label for="password" class="form-label">Contrase√±a</label>
                <input 
                    type="password" 
                    class="form-control pe-5" 
                    id="password" 
                    name="password"
                    required 
                    autocomplete="current-password"
                >
                <span onclick="togglePassword()" style="position:absolute; top:72.5%; right:18px; transform:translateY(-50%); cursor:pointer; color:#666; font-size: 1.3em;">
                    <i class="fa-solid fa-eye-slash" id="iconoPassword"></i>
                </span>
            </div>
            
            <div id="loginError" class="error-message">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="errorText"></span>
            </div>
            
            <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <span id="loginBtnText">Ingresar al Panel</span>
            </button>
        </form>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Variables globales
        let isLoading = false;
        
        // Funci√≥n para mostrar/ocultar contrase√±a (igual que en loginagroconecta)
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const iconoPassword = document.getElementById('iconoPassword');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                iconoPassword.classList.replace('fa-eye-slash', 'fa-eye');
            } else {
                passwordInput.type = 'password';
                iconoPassword.classList.replace('fa-eye', 'fa-eye-slash');
            }
        }
        
        // Funci√≥n para mostrar estado de carga
        function setLoading(loading) {
            isLoading = loading;
            const loginBtn = document.getElementById('loginBtn');
            const loginBtnText = document.getElementById('loginBtnText');
            const loadingSpinner = document.querySelector('.loading-spinner');
            
            if (loading) {
                loginBtn.disabled = true;
                loginBtnText.textContent = 'Verificando...';
                loadingSpinner.style.display = 'inline-block';
            } else {
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Ingresar al Panel';
                loadingSpinner.style.display = 'none';
            }
        }
        
        // Funci√≥n para mostrar errores
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('errorText');
            
            errorText.textContent = message;
            errorDiv.style.display = 'block';
            
            // Ocultar el error despu√©s de 5 segundos
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        // Funci√≥n para ocultar errores
        function hideError() {
            document.getElementById('loginError').style.display = 'none';
        }
        
        // Event listeners al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginPanelForm');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            
            // Enfocar el campo de usuario al cargar
            usernameInput.focus();
            
            // Ocultar errores cuando el usuario empiece a escribir
            usernameInput.addEventListener('input', hideError);
            passwordInput.addEventListener('input', hideError);
            
            // Manejar env√≠o del formulario
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (isLoading) return;
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();
                
                // Validaciones b√°sicas
                if (!username) {
                    showError('Por favor ingresa tu usuario');
                    usernameInput.focus();
                    return;
                }
                
                if (!password) {
                    showError('Por favor ingresa tu contrase√±a');
                    passwordInput.focus();
                    return;
                }
                
                // Iniciar proceso de login
                setLoading(true);
                hideError();
                
                console.log('üîê Intentando login con:', username);
                
                try {
                    const response = await fetch('/api/panel/auth/login', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        console.log('‚úÖ Login exitoso');
                        
                        // Guardar token
                        localStorage.setItem('token', result.token);
                        
                        // Mostrar mensaje de √©xito
                        Swal.fire({
                            title: '¬°Acceso Autorizado!',
                            text: 'Bienvenido al Panel de Control',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false,
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        }).then(() => {
                            window.location.href = '/html/panel_control/menu.html';
                        });
                        
                    } else {
                        console.log('‚ùå Error de login:', result.message);
                        setLoading(false);
                        showError(result.message || 'Usuario o contrase√±a incorrectos');
                        
                        // Limpiar campo de contrase√±a y enfocar usuario
                        passwordInput.value = '';
                        usernameInput.focus();
                    }
                    
                } catch (error) {
                    console.error('üí• Error de conexi√≥n:', error);
                    setLoading(false);
                    showError('Error de conexi√≥n. Verifica tu conexi√≥n a internet.');
                }
            });
            
            // Permitir env√≠o con Enter
            [usernameInput, passwordInput].forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !isLoading) {
                        form.dispatchEvent(new Event('submit'));
                    }
                });
            });
        });
        
        // Manejar errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
        });
        
        // Prevenir env√≠o m√∫ltiple
        window.addEventListener('beforeunload', function() {
            if (isLoading) {
                return 'Se est√° procesando tu solicitud...';
            }
        });
    </script>
</body>
</html>